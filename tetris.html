

<canvas  style ="margin-left: 345px"  id="tela" width="800" height="600"></canvas>
<canvas style = "margin-top: -600px;margin-left: 40px"  id="stats"  width="300" height="600"></canvas>
<canvas style = "margin-top: -600px;margin-left: 950px"  id="piece"  width="300" height="600"></canvas>


<script>

/*0
   Jogo: Tetris
   Autor: Code Explained (www.codeexplained.org)
*/

//Trilha sonora

    var soundtrack = document.getElementById('soundtrack');
    var gameover = document.getElementById('gameover');
    var pecaencaix = document.getElementById('peçaencaixando')
    var pecamex = document.getElementById('peçamexendo')
    var quebralinha= document.getElementById('quebralinha')

// Rotina principal

const I = [
	[
		[0, 0, 0, 0],
		[1, 1, 1, 1],
		[0, 0, 0, 0],
		[0, 0, 0, 0],
	],
	[
		[0, 0, 1, 0],
		[0, 0, 1, 0],
		[0, 0, 1, 0],
		[0, 0, 1, 0],
	],
	[
		[0, 0, 0, 0],
		[0, 0, 0, 0],
		[1, 1, 1, 1],
		[0, 0, 0, 0],
	],
	[
		[0, 1, 0, 0],
		[0, 1, 0, 0],
		[0, 1, 0, 0],
		[0, 1, 0, 0],
	]
];

const J = [
	[
		[1, 0, 0],
		[1, 1, 1],
		[0, 0, 0]
	],
	[
		[0, 1, 1],
		[0, 1, 0],
		[0, 1, 0]
	],
	[
		[0, 0, 0],
		[1, 1, 1],
		[0, 0, 1]
	],
	[
		[0, 1, 0],
		[0, 1, 0],
		[1, 1, 0]
	]
];

const L = [
	[
		[0, 0, 1],
		[1, 1, 1],
		[0, 0, 0]
	],
	[
		[0, 1, 0],
		[0, 1, 0],
		[0, 1, 1]
	],
	[
		[0, 0, 0],
		[1, 1, 1],
		[1, 0, 0]
	],
	[
		[1, 1, 0],
		[0, 1, 0],
		[0, 1, 0]
	]
];

const O = [
	[
		[0, 0, 0, 0],
		[0, 1, 1, 0],
		[0, 1, 1, 0],
		[0, 0, 0, 0],
	]
];

const S = [
	[
		[0, 1, 1],
		[1, 1, 0],
		[0, 0, 0]
	],
	[
		[0, 1, 0],
		[0, 1, 1],
		[0, 0, 1]
	],
	[
		[0, 0, 0],
		[0, 1, 1],
		[1, 1, 0]
	],
	[
		[1, 0, 0],
		[1, 1, 0],
		[0, 1, 0]
	]
];

const T = [
	[
		[0, 1, 0],
		[1, 1, 1],
		[0, 0, 0]
	],
	[
		[0, 1, 0],
		[0, 1, 1],
		[0, 1, 0]
	],
	[
		[0, 0, 0],
		[1, 1, 1],
		[0, 1, 0]
	],
	[
		[0, 1, 0],
		[1, 1, 0],
		[0, 1, 0]
	]
];

const Z = [
	[
		[1, 1, 0],
		[0, 1, 1],
		[0, 0, 0]
	],
	[
		[0, 0, 1],
		[0, 1, 1],
		[0, 1, 0]
	],
	[
		[0, 0, 0],
		[1, 1, 0],
		[0, 1, 1]
	],
	[
		[0, 1, 0],
		[1, 1, 0],
		[1, 0, 0]
	]
];

const PECAS = [
   //cores das peças
   
    [Z, "green"],
    [S, "red"],
    [T, "blue"],
    [O, "gray"],
    [L, "orange"],
    [I, "purple"],
    [J, "yellow"]
];

// tamanho da tela e cor de fundo.

const LINHA = 20;
const COLUNA = 20;
const TAMANHO = 30;
const VAGO = "black";
var space = 250
var size = 230;
var size2 = 250;
tabuleiro = [];
var piecestype = []
for (i = 0; i < 7; i++){
	piecestype[i] = 0;
}
var limite;
 let r = Math.floor(Math.random() * PECAS.length);
var nivel = 1;
var points = 0;
var lines2 = 0;
var lines = 0;
var mult = 1;
var inicioDescida;
var fimDeJogo = false;
var pup = 1000;

var rank = [];
// Imagem das peças
var img0 = new Image();
img0.src = "pecas/peca_Z.png"

var img1 = new Image();
img1.src = "pecas/peca_S.png"

var img2 = new Image();
img2.src = "pecas/peca_T.png"

var img3 = new Image();
img3.src = "pecas/peca_O.png"

var img4 = new Image();
img4.src = "pecas/peca_L.png"

var img5 = new Image();
img5.src = "pecas/peca_I.png"

var img6 = new Image();
img6.src = "pecas/peca_J.png"

var pieces = [img0, img1, img2, img3, img4, img5, img6];

onkeydown = controlarPeca;
//Iniciar jogo
iniciarTabuleiro();

desenharTabuleiro();

gerarPeca(r);

inicioDescida = Date.now();
var t = Math.floor(Math.random() * PECAS.length);
var u = Math.floor(Math.random() * PECAS.length);
var v = Math.floor(Math.random() * PECAS.length);

descerPeca();


// Sub-rotinas (funções)

function iniciarTabuleiro() {
	for (var i = 0; i < LINHA; i++) {
		tabuleiro[i] = [];
		
		for (var j = 0; j < COLUNA; j++) {
			tabuleiro[i][j] = VAGO;
		}
	}
}

function desenharTabuleiro(){
    for (var i = 0; i < LINHA; i++) {
        for (var j = 0; j < COLUNA; j++) {
            desenharQuadrado(j, i, tabuleiro[i][j]);
        }
    }
}

function desenharQuadrado(x, y, cor){
    c.fillStyle = cor;
    c.fillRect(x*TAMANHO, y*TAMANHO, TAMANHO, TAMANHO);

    c.strokeStyle = "black";
    c.strokeRect(x*TAMANHO, y*TAMANHO, TAMANHO, TAMANHO);;
}
	
function gerarPeca(e){
    

	peca = {
		tetramino : PECAS[e][0],
		cor : PECAS[e][1],
		tetraminoN : 0,
		tetraminoAtivo : [[]],
		x : 8,
		y : -2
		
	}

	peca.tetraminoAtivo = peca.tetramino[peca.tetraminoN];
	piecestype[e]++



}
	


function attplacar (t){

c2.fillStyle = "black"
c2.fillRect (0, 0 , 300, 600)
c2.fillStyle = "white";
c2.font = "30px sans-serif";
c2.fillText("Estatísticas:", 50, 50);
c2.font = "20px sans-serif";
c2.fillText("nivel: " + nivel, 50, 100);
c2.font = "20px sans-serif";
c2.fillText("pontos: " + points, 50, 150);
c2.font = "20px sans-serif";
c2.fillText("linhas: " + lines, 50, 200);
c3.fillStyle = "black";
c3.fillRect (0, 0, 300, 600)
c3.fillStyle = "white"
c3.font = "30px sans-serif";
c3.fillText("Próxima peça:", 50, 50);
c3.drawImage(pieces[t],50, 100);
c3.drawImage(pieces[u],50, 250);
c3.drawImage(pieces[v],50, 380);


}

function descerPeca(){
    var agora = Date.now();
    var delta = agora - inicioDescida;
    attplacar(t);
  
    if (delta > pup) {
        moverAbaixo();
        inicioDescida = Date.now();


    	}
	
    if (!fimDeJogo){
    	soundtrack.play();
        requestAnimationFrame(descerPeca);
    }	

}

function moverAbaixo(){
   
    if (!colisao(0, 1, peca.tetraminoAtivo)) {
        apagarPeca();
        peca.y++;
        desenharPeca();
        
    } 

    else{
     
        travarPeca();
        pecaencaix.play();
        gerarPeca(t) ;
    	t = u;
        u = v;
        v = Math.floor(Math.random() * PECAS.length);
    	
        c3.fillStyle = "black";
		c3.fillRect (0, 0, 300, 600)
		c3.fillStyle = "white"
		c3.font = "30px sans-serif";
		c3.fillText("Proxima peça:", 50, 50);
		c3.drawImage(pieces[t],50, 100);
        c3.drawImage(pieces[u],50, 250);
        c3.drawImage(pieces[v],50, 380);
	
    }
    	
}

function moverDireita(){
    if (!colisao(1, 0, peca.tetraminoAtivo)) {
        apagarPeca();
        peca.x++;
        desenharPeca();
       
    }
}

function moverEsquerda(){
    if (!colisao(-1, 0, peca.tetraminoAtivo)) {       
        apagarPeca();
        peca.x--;
        desenharPeca();

    }
}

function colisao(x, y, p){
    for (var i = 0; i < p.length; i++) {
        for (var j = 0; j < p.length; j++) {
            if (!p[i][j]) {
                continue;
            }
			
            var novoX = peca.x + j + x;
            var novoY = peca.y + i + y;
			
            if (novoX < 0 || novoX >= COLUNA || novoY >= LINHA) {
                return true;
            }
			
            if (novoY < 0) {
                continue;
            }
			
            if (tabuleiro[novoY][novoX] != VAGO) {
                return true;
            }
        }
    }

    return false;
}

function apagarPeca(){
    preencherPeca(VAGO);

}

function desenharPeca(){
    preencherPeca(peca.cor);
}

function preencherPeca(cor) {
    for (var i = 0; i < peca.tetraminoAtivo.length; i++) {
        for (var j = 0; j < peca.tetraminoAtivo.length; j++) {
            if (peca.tetraminoAtivo[i][j]) {
                desenharQuadrado(peca.x + j, peca.y + i, cor);
            }
        }
    }
}

function travarPeca(){
    for (var i = 0; i < peca.tetraminoAtivo.length; i++) {
        for (var j = 0; j < peca.tetraminoAtivo.length; j++) {
            if (!peca.tetraminoAtivo[i][j]) {
                continue;
            }
            
            //GAME OVER

            if (peca.y + i < 0) {
                 let size3 = tela.height/2 + 50
                 
                
                c.fillStyle = "black";
                c.fillRect = (0, 0, 800, 600)
                c.fillStyle = "white";
                c.font = "60px sans-serif";
                c.fillText("GAME OVER", 110, 300);
                c.fillStyle = "black";
                c.fillRect = (0,0,400,600);
                c.fillStyle = "white";
                c.font = "20px sans-serif";
                ranking();
            if(rank.length <= 5){
               limite = rank.length;
            }

            else{
                 limite = 5;
        }

            for(var flasco = 0; flasco < limite; flasco++){
                     
                     c.fillText(rank[flasco].nome, 150,size3)
                     c.fillText(rank[flasco].pts, 400,size3)
                    size3+= 50;
            }
			
            for(var jojo = 0; jojo < piecestype.length; jojo++){
               	 
               	 c2.fillStyle = "white";
                 c2.font = "20px sans-serif";
                 c2.fillText(piecestype[jojo], 100, size2);
                 c2.drawImage(pieces[jojo], 50, size, 25, 25)
                size += 30;
                size2 += 30;

                if(size == 440 && size2 == 460){
                	size = 230;
                	size2 = 250;

                }
               	
               	}
             ;
                fimDeJogo = true;
                soundtrack.pause();
				soundtrack.currentTime = 0;
                gameover.play();
                break;
            }

            tabuleiro[peca.y+i][peca.x+j] = peca.cor;
        }
    }
	let lines2 = 0;
    for (var i = 0; i < LINHA; i++) {
        var linhaCheia = true;
        for (var j = 0; j < COLUNA; j++) {
            linhaCheia = linhaCheia && (tabuleiro[i][j] != VAGO);
            
        }
		
        if (linhaCheia) {
           ; 
            for (var y = i; y > 1; y--) {
                for (var j = 0; j < COLUNA; j++) {
                    tabuleiro[y][j] = tabuleiro[y-1][j];
                }
            }
			
            for (var j = 0; j < COLUNA; j++) {
                tabuleiro[0][j] = VAGO;
                quebralinha.play();
            }
            
            lines2 ++
            lines++
            
        	
        	if(lines % 10 == 0){
        		nivel++
        		mult++
        		pup -= 50
        		lines = 0
        	}

        	
        }

    }
	if(lines2 == 1){
        	points += 100*mult;
        	} 
       		
     if(lines2 == 2){
        		points += 300*mult;
        	} 
       if(lines2 == 3){
        		points += 500*mult;
        	}

       if (lines2 >= 4) {
        		points += 800*mult;
        	} 


    

    desenharTabuleiro();
}

function rodarPeca(){
    var proximoPadrao = peca.tetramino[(peca.tetraminoN + 1) % peca.tetramino.length];
    var recuo = 0;

    if (colisao(0, 0, proximoPadrao)) {
        if (peca.x > COLUNA/2) {
            recuo = -1;
        } 
        else{
            recuo = 1;
        }
    }
    
    if (!colisao(recuo, 0, proximoPadrao)) {
        apagarPeca();
        peca.x += recuo;
        peca.tetraminoN = (peca.tetraminoN + 1) % peca.tetramino.length;
        peca.tetraminoAtivo = peca.tetramino[peca.tetraminoN];
        desenharPeca();
    }
}

function rodarPeca2(){
    var proximoPadrao = peca.tetramino[Math.abs(peca.tetraminoN - 1) % peca.tetramino.length];
    var recuo = 0;
     
     if(peca.tetraminoN == 0){
            peca.tetraminoN = peca.tetramino.length;
        }
    
    if (colisao(0, 0, proximoPadrao)) {
        if (peca.x > COLUNA/2) {
            recuo = -1;
        } else {
            recuo = 1;
        }
    }
    if (!colisao(recuo, 0, proximoPadrao)) {
        apagarPeca();
        peca.x += recuo;
        peca.tetraminoN = (peca.tetraminoN - 1) % peca.tetramino.length;
        peca.tetraminoAtivo = peca.tetramino[peca.tetraminoN];
        desenharPeca();
         
    }
}


function ranking(){
    if(fimDeJogo!== true){
    rank = JSON.parse(localStorage.getItem('rank'))
     if(rank == null){
    rank = [];
   }
   
    var name = prompt("digite suas iniciais").slice(0,3);
     
     if(name !== ""){   
   
    pessoa = {
        nome: name,
        pts: points,
    }

var aux = "";
for(w = 0; w < rank.length; w++){
    if(pessoa.nome == rank[w].nome){
        if(pessoa.pts > rank[w].pts){
            rank[w].pts = pessoa.pts;  
        }
        aux = 'cheio';
    }
}        
if(aux !== 'cheio'){
rank.push(pessoa);   
 }   
  
        if(rank.length > 1){
                
            for (var k = 0; k < rank.length-1; k++) {
                for (var j = 0; j < rank.length-1-k; j++) {
                    if (rank[j].pts < rank[j+1].pts) {
                        aux = rank[j];
                        rank[j] = rank[j+1];
                        rank[j+1] = aux;
                    }
                }
            }

   
    }

    if(rank.length > 8){ 
        while(rank.length > 8){
            rank.pop();
        }

    }
}


localStorage.setItem('rank', JSON.stringify(rank));
}
}         


function controlarPeca(evento){
	var tecla = evento.keyCode;
    if(fimDeJogo!== true){
    if (tecla == 37) {
        pecamex.play();
        moverEsquerda();
        inicioDescida = Date.now();
    } 
    else if (tecla == 38) {
        rodarPeca();
        pecamex.play();
        inicioDescida = Date.now();
    }
    else if (tecla == 39) {
        moverDireita();
        pecamex.play();
        inicioDescida = Date.now();
    } 
    else if (tecla == 40) {
      
        moverAbaixo();
        pecamex.play();
        points++
        
    }
    else if (tecla == 90) {
        rodarPeca2();
        pecamex.play();
        inicioDescida = Date.now();
    }
    else if (tecla == 32) {
      
      while(!colisao(0, 1, peca.tetraminoAtivo)){
        moverAbaixo()
        points += 2;
       pecamex.play();
      }
    }
}
}

</script>